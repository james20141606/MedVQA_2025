# 模型验证和重试机制说明

## 概述

为了确保所有模型都能生成有效的响应，我为每个模型的测试脚本添加了验证和重试机制。当模型生成无效响应时，系统会自动重试最多3次。

## 已修改的模型

### 1. MMaDA (`test_mmada_batch.py`)
- **验证条件**：
  - 响应不为空且长度≥3
  - 不包含无效模式：`<image>`, `[ERROR]`, `error`, `failed`, `exception`
- **重试机制**：最多3次重试
- **特点**：专门处理MMaDA特有的`<image>`响应问题

### 2. Thyme (`test_thyme_batch.py`)
- **验证条件**：
  - 响应不为空且长度≥10
  - `model_answer`不为空（从响应中提取的答案）
  - 不包含无效模式：`[ERROR]`, `error`, `failed`, `exception`
- **重试机制**：最多3次重试
- **特点**：检查提取的答案是否有效

### 3. InternVL系列 (`test_internvl30b_batch.py`, `test_internvl38b_batch.py`, `test_internvl8b_batch.py`)
- **验证条件**：
  - 响应不为空且长度≥5
  - 不包含无效模式：`[ERROR]`, `error`, `failed`, `exception`, `sorry`, `i cannot`, `i don't`, `i'm unable`
- **重试机制**：最多3次重试
- **特点**：检查常见的拒绝回答模式

### 4. GLM4V (`test_glm4v_batch.py`)
- **验证条件**：
  - 响应不为空且长度≥5
  - 不包含无效模式：`[ERROR]`, `error`, `failed`, `exception`, `sorry`, `i cannot`, `i don't`, `i'm unable`, `i am unable`
- **重试机制**：最多3次重试
- **特点**：与InternVL类似的验证逻辑

### 5. Qwen系列 (`test_qwen25vl7b_batch.py`, `test_qwen25vl32b_batch.py`)
- **验证条件**：
  - 响应不为空且长度≥5
  - 对于7B版本：检查提取的答案是否为空
  - 不包含无效模式：`[ERROR]`, `error`, `failed`, `exception`, `sorry`, `i cannot`, `i don't`, `i'm unable`, `i am unable`
- **重试机制**：最多3次重试
- **特点**：7B版本额外检查提取的答案有效性

## 验证逻辑

### 通用无效模式检测
所有模型都会检测以下无效响应模式：
- `[ERROR]` - 系统错误
- `error` - 错误信息
- `failed` - 失败信息
- `exception` - 异常信息
- `sorry` - 道歉/拒绝回答
- `i cannot` - 无法回答
- `i don't` - 不知道
- `i'm unable` - 无法处理
- `i am unable` - 无法处理

### 模型特定验证
- **MMaDA**: 专门检测`<image>`响应
- **Thyme**: 检查提取的`model_answer`是否为空
- **Qwen 7B**: 检查提取的答案是否为空

### 长度验证
- **MMaDA**: 最小长度3字符
- **Thyme**: 最小长度10字符
- **其他模型**: 最小长度5字符

## 重试机制

1. **最大重试次数**: 3次
2. **重试条件**: 响应验证失败或发生异常
3. **重试间隔**: 立即重试（无延迟）
4. **最终处理**: 如果3次重试都失败，保存最后一次的响应（即使是无效的）

## 日志输出

重试过程中会输出以下信息：
- 重试次数和原因
- 无效响应的前50个字符
- 最终失败时的完整响应（用于调试）

## 使用建议

1. **监控日志**: 关注重试次数较多的样本，可能需要手动检查
2. **调整参数**: 可以根据需要调整最大重试次数和验证条件
3. **性能考虑**: 重试会增加处理时间，但能提高数据质量
4. **错误分析**: 最终失败的样本可以用于分析模型的问题

## 预期效果

通过这些验证和重试机制，预期能够：
- 减少无效响应的数量
- 提高评估结果的准确性
- 减少需要手动重新运行的样本
- 提供更好的错误诊断信息


